<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ category.name }} - Products</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .product-card {
            min-height: 100%;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .product-details {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .search-dropdown {
            display: none;
            position: absolute;
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            z-index: 10;
            background: white;
            border: 1px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .main-image-container {
            border-radius: 8px;
            overflow: hidden;
            height: 350px;
            /* Adjust height as needed */
            background-color: transparent;
            /* Remove gray background */
        }

        .main-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            /* This will fill the container */
            border-radius: 8px;
            /* Add rounded corners to image */
        }

        .thumbnail-img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            /* Rounded corners for thumbnails */
            flex-shrink: 0;
        }

        .action-buttons {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .action-buttons {
                flex-direction: column;
                gap: 1rem;
            }

            .action-buttons a {
                width: 100%;
            }

            .main-image-container {
                height: 300px;
            }

            .thumbnail-img {
                width: 80px;
                height: 80px;
            }
        }
    </style>
</head>

<body class="bg-gray-50 p-6">
    <!-- Search Bar with Dropdown -->
    <div class="max-w-4xl mx-auto mb-10 relative">
        <input type="text" id="searchInput" placeholder="Search products..."
            class="w-full p-4 text-lg border-2 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
            onfocus="showSearchDropdown()">
        <div id="searchDropdown" class="search-dropdown">
            <!-- Search results will appear here -->
        </div>
    </div>

    <div class="max-w-6xl mx-auto p-6">
        <!-- Display Category Name -->
        <h2 class="text-3xl md:text-4xl font-bold mb-4 text-gray-800">{{ category.name }}</h2>

        <!-- Display Category Description -->
        <div class="text-gray-700 text-lg mb-10">
            <div id="categoryDescription" class="line-clamp-3">
                {{ category.description }}
            </div>
            {% if category.description|length > 200 %}
            <button onclick="expandDescription()" class="text-indigo-600 font-semibold mt-3 hover:underline">Read
                More</button>
            {% endif %}
        </div>
    </div>

    <!-- Products Container -->
    <div id="productsContainer" class="max-w-6xl mx-auto space-y-10"></div>

    <!-- Hidden JSON Data -->
    <script type="application/json" id="productData">
        {{ products | tojson | safe }}
    </script>

    <script>
        const products = JSON.parse(document.getElementById("productData").textContent);
        const searchInput = document.getElementById("searchInput");
        const searchDropdown = document.getElementById("searchDropdown");

        // Function to show search dropdown
        function showSearchDropdown() {
            searchDropdown.style.display = 'block';
            updateSearchDropdown('');
        }

        // Function to hide search dropdown
        function hideSearchDropdown() {
            setTimeout(() => {
                searchDropdown.style.display = 'none';
            }, 200);
        }

        // Function to update search dropdown
        function updateSearchDropdown(filter = "") {
            searchDropdown.innerHTML = products
                .filter(product =>
                    product.name.toLowerCase().includes(filter.toLowerCase())
                )
                .map(product => `
                    <div class="p-4 hover:bg-gray-50 cursor-pointer border-b border-gray-100 last:border-b-0"
                         onclick="selectProduct('${product.id}', '${product.name.replace(/'/g, "\\'")}')">
                        <div class="font-medium">${product.name}</div>
                        <div class="text-sm text-gray-500 mt-1">${product.price ? `â‚¹${parseFloat(product.price).toFixed(2)}` : ""}</div>
                    </div>
                `)
                .join('');
        }

        // Function to select product from dropdown
        function selectProduct(productId, productName) {
            searchInput.value = productName;
            createProductSections(productId);
            hideSearchDropdown();
            // Focus on the selected product
            const element = document.getElementById(`product-${productId}`);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        // Function to expand category description
        function expandDescription() {
            const desc = document.getElementById("categoryDescription");
            desc.classList.toggle("line-clamp-3");
            const button = desc.nextElementSibling;
            button.textContent = desc.classList.contains("line-clamp-3") ? "Read More" : "Show Less";
        }

        // Function to create product sections dynamically
        function createProductSections(filter = "") {
            const container = document.getElementById("productsContainer");
            container.innerHTML = "";

            let filteredProducts = products;

            if (typeof filter === 'string' && filter.trim() !== "") {
                // Text search
                filteredProducts = products.filter(product =>
                    product.name.toLowerCase().includes(filter.toLowerCase()) ||
                    (product.description && product.description.toLowerCase().includes(filter.toLowerCase())))
            } else if (typeof filter === 'string') {
                // Show all products
                filteredProducts = products;
            } else {
                // Filter by product ID
                filteredProducts = products.filter(product => product.id === filter);
            }

            if (filteredProducts.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-16">
                        <p class="text-gray-500 text-xl">No products found matching "${filter}"</p>
                    </div>
                `;
                return;
            }

            filteredProducts.forEach((product, index) => {
                const mainImage = (product.images && product.images.length > 0) ?
                    product.images[0] : "/static/default-product.jpg";
                const price = product.price ? `â‚¹${parseFloat(product.price).toFixed(2)}` : "N/A";
                const specs = product.specs || {};

                const productHTML = `
                <div id="product-${product.id}" class="product-card bg-white shadow-md rounded-xl overflow-hidden">
                    <div class="p-8">
                        <h1 class="text-2xl font-bold text-gray-800 mb-6">${product.name}</h1>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <!-- Product Image Section -->
                            <div class="flex flex-col">
                            <div class="main-image-container">
                                <img id="mainImage${index}" src="${mainImage}" alt="Main Product Image"
                                    class="main-image">
                            </div>

                                <div class="thumbnails flex mt-6 space-x-3 overflow-x-auto py-2 px-1">
                                    ${(product.images || []).map((img, imgIndex) => `
                                        <img src="${img}" alt="Thumbnail ${imgIndex + 1}"
                                            class="thumbnail-img rounded-lg cursor-pointer border-2 ${imgIndex === 0 ? 'border-indigo-500' : 'border-transparent'} hover:border-indigo-600"
                                            onclick="changeMainImage(${index}, this)">
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Product Details -->
                            <div class="product-details space-y-6">
                                <p class="text-2xl font-bold text-indigo-600">${price}</p>

                                ${Object.keys(specs).length > 0 ? `
                                <div class="specs bg-gray-50 p-5 rounded-lg text-gray-600 space-y-3">
                                    ${Object.entries(specs).map(([key, value]) => `
                                        <p class="text-base"><strong class="text-gray-800">${key}:</strong> ${value}</p>
                                    `).join('')}
                                </div>
                                ` : ''}

                                <div class="description text-gray-700 text-base leading-relaxed line-clamp-4">
                                    ${product.description || 'No description available'}
                                </div>

                                <div class="mt-auto pt-6 action-buttons">
                                    <a href="/product/${product.id}" 
                                       class="flex-1 text-center bg-gray-100 hover:bg-gray-200 text-gray-800 font-medium px-6 py-3 rounded-lg transition duration-300">
                                        ðŸ‘€ View Details
                                    </a>
                                    <a href="/inquire?product_id=${product.id}" 
                                       class="flex-1 text-center bg-indigo-600 hover:bg-indigo-700 text-white font-medium px-6 py-3 rounded-lg transition duration-300">
                                        ðŸ“© I'm Interested
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                `;
                container.insertAdjacentHTML('beforeend', productHTML);
            });
        }

        // Function to change main image on click
        function changeMainImage(productIndex, element) {
            document.getElementById(`mainImage${productIndex}`).src = element.src;
            // Update thumbnail borders
            element.parentElement.querySelectorAll('.thumbnail-img').forEach(img => {
                img.classList.remove('border-indigo-500');
                img.classList.add('border-transparent');
            });
            element.classList.remove('border-transparent');
            element.classList.add('border-indigo-500');
        }

        // Event listeners
        searchInput.addEventListener("input", function () {
            const searchTerm = this.value;
            if (searchTerm === "") {
                createProductSections();
            } else {
                updateSearchDropdown(searchTerm);
            }
        });

        searchInput.addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
                createProductSections(this.value);
                hideSearchDropdown();
            }
        });

        // Initialize page
        createProductSections();
    </script>
</body>

</html>