<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ category.name }} - Products</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .thumbnail-img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            flex-shrink: 0;
        }

        .product-card {
            min-height: 100%;
            display: flex;
            flex-direction: column;
        }

        .product-details {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .search-dropdown {
            display: none;
            position: absolute;
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            z-index: 10;
            background: white;
            border: 1px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .main-image-container {
            border-radius: 8px;
            overflow: hidden;
        }

        .main-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .action-buttons {
                flex-direction: column;
                gap: 0.5rem;
            }

            .action-buttons a {
                width: 100%;
            }
        }
    </style>
</head>

<body class="bg-gray-100 p-4">
    <!-- Search Bar with Dropdown -->
    <div class="max-w-3xl mx-auto mb-6 relative">
        <input type="text" id="searchInput" placeholder="Search products..."
            class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
            onfocus="showSearchDropdown()">
        <div id="searchDropdown" class="search-dropdown">
            <!-- Search results will appear here -->
        </div>
    </div>

    <div class="max-w-5xl mx-auto p-4">
        <!-- Display Category Name -->
        <h2 class="text-2xl md:text-3xl font-bold mb-2">{{ category.name }}</h2>

        <!-- Display Category Description -->
        <div class="text-gray-700 mb-6">
            <div id="categoryDescription" class="line-clamp-3">
                {{ category.description }}
            </div>
            {% if category.description|length > 200 %}
            <button onclick="expandDescription()" class="text-purple-600 font-semibold mt-1">Read More</button>
            {% endif %}
        </div>
    </div>

    <!-- Products Container -->
    <div id="productsContainer" class="max-w-5xl mx-auto space-y-6"></div>

    <!-- Hidden JSON Data -->
    <script type="application/json" id="productData">
        {{ products | tojson | safe }}
    </script>

    <script>
        const products = JSON.parse(document.getElementById("productData").textContent);
        const searchInput = document.getElementById("searchInput");
        const searchDropdown = document.getElementById("searchDropdown");

        // Function to show search dropdown
        function showSearchDropdown() {
            searchDropdown.style.display = 'block';
            updateSearchDropdown('');
        }

        // Function to hide search dropdown
        function hideSearchDropdown() {
            setTimeout(() => {
                searchDropdown.style.display = 'none';
            }, 200);
        }

        // Function to update search dropdown
        function updateSearchDropdown(filter = "") {
            searchDropdown.innerHTML = products
                .filter(product =>
                    product.name.toLowerCase().includes(filter.toLowerCase())
                )
                .map(product => `
                    <div class="p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-200 last:border-b-0"
                         onclick="selectProduct('${product.id}', '${product.name.replace(/'/g, "\\'")}')">
                        ${product.name}
                    </div>
                `)
                .join('');
        }

        // Function to select product from dropdown
        function selectProduct(productId, productName) {
            searchInput.value = productName;
            createProductSections(productId);
            hideSearchDropdown();
            // Focus on the selected product
            const element = document.getElementById(`product-${productId}`);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        // Function to expand category description
        function expandDescription() {
            const desc = document.getElementById("categoryDescription");
            desc.classList.toggle("line-clamp-3");
            const button = desc.nextElementSibling;
            button.textContent = desc.classList.contains("line-clamp-3") ? "Read More" : "Show Less";
        }

        // Function to create product sections dynamically
        function createProductSections(filter = "") {
            const container = document.getElementById("productsContainer");
            container.innerHTML = "";

            let filteredProducts = products;

            if (typeof filter === 'string' && filter.trim() !== "") {
                // Text search
                filteredProducts = products.filter(product =>
                    product.name.toLowerCase().includes(filter.toLowerCase()) ||
                    (product.description && product.description.toLowerCase().includes(filter.toLowerCase())))
            } else if (typeof filter === 'string') {
                // Show all products
                filteredProducts = products;
            } else {
                // Filter by product ID
                filteredProducts = products.filter(product => product.id === filter);
            }

            if (filteredProducts.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-10">
                        <p class="text-gray-500 text-lg">No products found matching "${filter}"</p>
                    </div>
                `;
                return;
            }

            filteredProducts.forEach((product, index) => {
                const mainImage = (product.images && product.images.length > 0) ?
                    product.images[0] : "/static/default-product.jpg";
                const price = product.price ? `â‚¹${parseFloat(product.price).toFixed(2)}` : "N/A";
                const specs = product.specs || {};

                const productHTML = `
                <div id="product-${product.id}" class="product-card bg-white shadow rounded-lg overflow-hidden">
                    <div class="p-5">
                        <h1 class="text-xl font-bold text-gray-800 mb-3">${product.name}</h1>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <!-- Product Image Section -->
                            <div class="flex flex-col">
                                <div class="main-image-container w-full h-64 overflow-hidden bg-gray-200">
                                    <img id="mainImage${index}" src="${mainImage}" alt="Main Product Image"
                                         class="main-image">
                                </div>

                                <div class="thumbnails flex mt-3 space-x-2 overflow-x-auto py-1">
                                    ${(product.images || []).map((img, imgIndex) => `
                                        <img src="${img}" alt="Thumbnail ${imgIndex + 1}"
                                            class="thumbnail-img rounded cursor-pointer border-2 ${imgIndex === 0 ? 'border-indigo-500' : 'border-transparent'} hover:border-indigo-600"
                                            onclick="changeMainImage(${index}, this)">
                                    `).join('')}
                                </div>
                            </div>

                            <!-- Product Details -->
                            <div class="product-details space-y-3">
                                <p class="text-lg font-semibold text-gray-700">${price}</p>

                                ${Object.keys(specs).length > 0 ? `
                                <div class="specs text-gray-600 space-y-1 text-sm">
                                    ${Object.entries(specs).map(([key, value]) => `
                                        <p><strong class="text-gray-800">${key}:</strong> ${value}</p>
                                    `).join('')}
                                </div>
                                ` : ''}

                                <div class="description text-gray-700 text-sm leading-relaxed line-clamp-4">
                                    ${product.description || 'No description available'}
                                </div>

                                <div class="mt-auto pt-3 action-buttons">
                                    <a href="/product/${product.id}" 
                                       class="flex-1 text-center bg-gray-200 text-gray-800 font-medium px-4 py-2 rounded hover:bg-gray-300 transition">
                                        ðŸ‘€ View Details
                                    </a>
                                    <a href="/inquire?product_id=${product.id}" 
                                       class="flex-1 text-center bg-indigo-600 text-white font-medium px-4 py-2 rounded hover:bg-indigo-700 transition">
                                        ðŸ“© I'm Interested
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                `;
                container.insertAdjacentHTML('beforeend', productHTML);
            });
        }

        // Function to change main image on click
        function changeMainImage(productIndex, element) {
            document.getElementById(`mainImage${productIndex}`).src = element.src;
            // Update thumbnail borders
            element.parentElement.querySelectorAll('.thumbnail-img').forEach(img => {
                img.classList.remove('border-indigo-500');
                img.classList.add('border-transparent');
            });
            element.classList.remove('border-transparent');
            element.classList.add('border-indigo-500');
        }

        // Event listeners
        searchInput.addEventListener("input", function () {
            const searchTerm = this.value;
            if (searchTerm === "") {
                createProductSections();
            } else {
                updateSearchDropdown(searchTerm);
            }
        });

        searchInput.addEventListener("keypress", function (e) {
            if (e.key === "Enter") {
                createProductSections(this.value);
                hideSearchDropdown();
            }
        });

        // Initialize page
        createProductSections();
    </script>
</body>

</html>